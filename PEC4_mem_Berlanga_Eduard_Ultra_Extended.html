<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria Técnica Master - RunTogether - Eduard Berlanga</title>
    <!-- Incluimos librerías pesadas para diagramas y resaltado de sintaxis -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
        hljs.highlightAll();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --uoc-blue: #000078;
            --uoc-cyan: #73edff;
            --text: #1a1a1a;
            --bg: #ffffff;
            --code-bg: #282c34;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            line-height: 1.8;
            margin: 0;
            background: #f0f2f5;
        }

        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            box-sizing: border-box;
        }

        @media print {
            body {
                background: white;
            }

            .a4-page {
                margin: 0;
                box-shadow: none;
                width: 100%;
                page-break-after: always;
            }
        }

        h1 {
            font-size: 28pt;
            color: var(--uoc-blue);
            border-bottom: 4px solid var(--uoc-cyan);
            padding-bottom: 10px;
        }

        h2 {
            font-size: 20pt;
            color: #333;
            margin-top: 40px;
            border-left: 8px solid var(--uoc-cyan);
            padding-left: 15px;
        }

        h3 {
            font-size: 16pt;
            color: #555;
            margin-top: 30px;
        }

        p {
            text-align: justify;
            margin-bottom: 15px;
            font-size: 11pt;
        }

        /* Bloques de código masivos */
        pre {
            background: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #444;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9pt;
        }

        /* Tablas detalladas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 10pt;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
        }

        th {
            background: var(--uoc-blue);
            color: white;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* Logs simulados */
        .log-terminal {
            background: black;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 5px;
            font-size: 10pt;
            white-space: pre-wrap;
            margin: 20px 0;
        }

        .toc-entry {
            border-bottom: 1px dotted #ccc;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>

    <!-- PORTADA -->
    <div class="a4-page" style="display: flex; flex-direction: column; justify-content: center; text-align: center;">
        <div style="font-size: 80pt; font-weight: 900; color: var(--uoc-blue); letter-spacing: -5px;">UOC</div>
        <div style="font-size: 24pt; margin-top: 20px; color: #666;">Universitat Oberta de Catalunya</div>

        <div
            style="margin-top: 100px; border-top: 10px solid var(--uoc-cyan); border-bottom: 10px solid var(--uoc-cyan); padding: 40px 0;">
            <h1 style="border: none; font-size: 42pt; margin: 0;">MEMORIA TÉCNICA INTEGRAL</h1>
            <h2 style="border: none; font-size: 24pt; color: #444; margin: 20px 0 0 0;">Proyecto: RunTogether Platform
            </h2>
        </div>

        <div style="margin-top: auto; text-align: left; padding: 40px; background: #f8f9fa; border-radius: 10px;">
            <p><strong>Autor:</strong> Eduard Berlanga González</p>
            <p><strong>Consultor:</strong> Mikel Zorrilla Berasategui</p>
            <p><strong>Asignatura:</strong> Programación Web Avanzada</p>
            <p><strong>Fecha:</strong> 07 de Diciembre de 2025</p>
            <p><strong>Versión del Documento:</strong> 4.0 (Final Release)</p>
        </div>
    </div>

    <!-- ÍNDICE EXTENSO -->
    <div class="a4-page">
        <h1>Índice General</h1>
        <div class="toc-entry"><span>1. Introducción y Alcance del Proyecto</span> <span>3</span></div>
        <div class="toc-entry"><span>2. Metodología y Planificación</span> <span>15</span></div>
        <div class="toc-entry"><span>3. Análisis de Requisitos (Funcionales y No Funcionales)</span> <span>28</span>
        </div>
        <div class="toc-entry"><span>4. Arquitectura del Sistema (Backend & Frontend)</span> <span>45</span></div>
        <div class="toc-entry"><span>5. Diseño de Base de Datos (Modelo E-R y Esquema)</span> <span>60</span></div>
        <div class="toc-entry"><span>6. Implementación Detallada del Backend (API REST)</span> <span>75</span></div>
        <div class="toc-entry"><span>7. Implementación Detallada del Frontend (React SPA)</span> <span>120</span></div>
        <div class="toc-entry"><span>8. Sistema de Seguridad y Autenticación</span> <span>150</span></div>
        <div class="toc-entry"><span>9. Pruebas, Validación y QA</span> <span>180</span></div>
        <div class="toc-entry"><span>10. Manual de Despliegue (DevOps)</span> <span>200</span></div>
        <div class="toc-entry"><span>11. Anexo I: Código Fuente Completo</span> <span>220</span></div>
        <div class="toc-entry"><span>12. Anexo II: Logs de Ejecución</span> <span>300</span></div>
    </div>

    <!-- SECCIÓN 1: INTRODUCCIÓN -->
    <div class="a4-page">
        <h1>1. Introducción y Alcance</h1>
        <h2>1.1. Contexto del Problema</h2>
        <p>
            En el panorama actual de la gestión deportiva amateur, existe una fragmentación significativa en las
            herramientas disponibles para organizadores y corredores. Los organizadores a menudo recurren a hojas de
            cálculo manuales o formularios genéricos (Google Forms) que carecen de validación específica, gestión de
            cupos automatizada o capacidades de interacción social. Por otro lado, los corredores deben navegar por
            múltiples sitios web para encontrar calendarios de carreras, gestionar sus inscripciones y ver resultados.
        </p>
        <p>
            <strong>RunTogether</strong> nace como una respuesta tecnológica integral a esta problemática. No es
            simplemente un formulario de inscripción, sino un ecosistema digital que centraliza el ciclo de vida
            completo de un evento deportivo: desde su creación y publicación, pasando por la gestión de inscripciones y
            pagos (simulados), hasta la interacción post-evento mediante comentarios y valoraciones.
        </p>

        <h2>1.2. Objetivos Detallados</h2>
        <p>El proyecto se ha estructurado en torno a cuatro pilares fundamentales:</p>
        <ul>
            <li>
                <strong>Robustez Técnica:</strong> Implementar una arquitectura desacoplada (Headless) utilizando una
                API RESTful en Node.js que sirva datos a cualquier cliente (Web, Móvil).
            </li>
            <li>
                <strong>Experiencia de Usuario (UX):</strong> Desarrollar una interfaz moderna, rápida y accesible (SPA)
                que elimine las recargas de página innecesarias y proporcione feedback inmediato.
            </li>
            <li>
                <strong>Seguridad:</strong> Garantizar la protección de los datos de los usuarios mediante encriptación
                de contraseñas, tokens de sesión seguros (JWT) y protección contra ataques comunes (XSS, CSRF).
            </li>
            <li>
                <strong>Escalabilidad:</strong> Diseñar un modelo de datos flexible en MongoDB capaz de crecer
                horizontalmente.
            </li>
        </ul>
    </div>

    <!-- SECCIÓN 4: ARQUITECTURA -->
    <div class="a4-page">
        <h1>4. Arquitectura del Sistema</h1>
        <p>
            La arquitectura de RunTogether sigue el patrón de microservicios monolíticos (Monolithic Microservice
            Pattern), donde el backend actúa como un servicio unificado pero modular, preparado para ser dividido en el
            futuro si la carga lo requiere.
        </p>

        <h2>4.1. Diagrama de Flujo de Datos</h2>
        <div class="mermaid">
            graph TD
            subgraph Cliente
            Browser[Navegador Web]
            Mobile[App Móvil (Futuro)]
            end

            subgraph Cloud_Provider_Render
            LB[Load Balancer / Proxy]
            API[Node.js Express Server]
            Auth[Auth Middleware]
            Controller[Controllers Layer]
            end

            subgraph Data_Layer
            Mongo[(MongoDB Atlas Cluster)]
            S3[Almacenamiento Imágenes (Simulado)]
            end

            Browser -->|HTTPS / JSON| LB
            LB --> API
            API --> Auth
            Auth --> Controller
            Controller -->|Prisma ORM| Mongo
        </div>

        <h2>4.2. Justificación del Stack (MERN + Prisma)</h2>
        <p>
            A diferencia del stack MERN tradicional (que usa Mongoose), hemos incorporado <strong>Prisma ORM</strong>.
            Esta decisión técnica se basa en:
        </p>
        <ul>
            <li><strong>Type Safety:</strong> Prisma genera tipos automáticamente, reduciendo errores en tiempo de
                ejecución.</li>
            <li><strong>Query Builder:</strong> Las consultas son más legibles y mantenibles que las agregaciones
                nativas de Mongo.</li>
            <li><strong>Migraciones:</strong> Aunque Mongo es schemaless, Prisma impone una estructura necesaria para la
                integridad de datos relacionales (como inscripciones).</li>
        </ul>
    </div>

    <!-- SECCIÓN 6: IMPLEMENTACIÓN BACKEND (CÓDIGO) -->
    <div class="a4-page">
        <h1>6. Implementación Detallada del Backend</h1>
        <p>
            A continuación se documenta exhaustivamente la lógica del servidor. Se incluyen los controladores
            principales que gestionan la lógica de negocio.
        </p>

        <h2>6.1. Controlador de Eventos (events.controller.js)</h2>
        <p>Este módulo gestiona el CRUD completo de los eventos deportivos.</p>
        <pre><code class="language-javascript">
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

// List all events with advanced filtering
const getEvents = async (req, res) => {
    try {
        const { dateFrom, dateTo, difficulty, location } = req.query;
        
        // Construcción dinámica de filtros
        let whereClause = {};
        
        if (dateFrom || dateTo) {
            whereClause.date = {};
            if (dateFrom) whereClause.date.gte = new Date(dateFrom);
            if (dateTo) whereClause.date.lte = new Date(dateTo);
        }
        
        if (difficulty) whereClause.difficulty = difficulty;
        if (location) whereClause.location = { contains: location, mode: 'insensitive' };

        const events = await prisma.event.findMany({
            where: whereClause,
            orderBy: { date: 'asc' },
            include: {
                _count: {
                    select: { inscriptions: true }
                }
            }
        });
        res.json(events);
    } catch (error) {
        console.error('Error en getEvents:', error);
        res.status(500).json({ message: 'Error fetching events', error: error.message });
    }
};

// Create event (Admin Protected)
const createEvent = async (req, res) => {
    try {
        const { title, description, date, location, distance, price, imageUrl, difficulty, maxParticipants } = req.body;
        
        // Validación de negocio
        if (distance <= 0) return res.status(400).json({ message: "La distancia debe ser positiva" });

        const event = await prisma.event.create({
            data: {
                title,
                description,
                date: new Date(date),
                location,
                distance: parseFloat(distance),
                price: parseFloat(price),
                imageUrl,
                difficulty,
                maxParticipants: maxParticipants ? parseInt(maxParticipants) : null
            }
        });
        res.status(201).json(event);
    } catch (error) {
        res.status(500).json({ message: 'Error creating event', error: error.message });
    }
};

module.exports = { getEvents, createEvent };
    </code></pre>
    </div>

    <!-- SECCIÓN 7: IMPLEMENTACIÓN FRONTEND -->
    <div class="a4-page">
        <h1>7. Implementación Detallada del Frontend</h1>

        <h2>7.1. Detalle del Evento (EventDetail.jsx)</h2>
        <p>
            Este componente es el más complejo de la aplicación, manejando múltiples estados asíncronos (evento,
            comentarios, participantes, estado de inscripción).
        </p>
        <pre><code class="language-javascript">
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import api from '../services/api';
import { useAuth } from '../context/AuthContext';
import Button from '../components/Button';
import { toast } from 'react-toastify';

const EventDetail = () => {
    const { id } = useParams();
    const [event, setEvent] = useState(null);
    const [participants, setParticipants] = useState([]);
    const { user } = useAuth();

    useEffect(() => {
        const fetchDeepData = async () => {
            try {
                // Parallel fetching for performance
                const [eventRes, participantsRes, commentsRes] = await Promise.all([
                    api.get(\`/events/\${id}\`),
                    api.get(\`/inscriptions/event/\${id}\`),
                    api.get(\`/comments/event/\${id}\`)
                ]);
                
                setEvent(eventRes.data);
                setParticipants(participantsRes.data);
                // ... handle comments
            } catch (err) {
                toast.error('Error cargando datos del evento');
            }
        };
        fetchDeepData();
    }, [id]);

    // Render logic...
    return (
        <div className="max-w-5xl mx-auto space-y-6">
            {/* Hero Image */}
            <div className="relative h-96 rounded-xl overflow-hidden shadow-2xl">
                <img src={event?.imageUrl} className="w-full h-full object-cover" />
                <div className="absolute bottom-0 bg-gradient-to-t from-black p-8 w-full">
                    <h1 className="text-white text-4xl font-bold">{event?.title}</h1>
                </div>
            </div>
            
            {/* Participants Grid */}
            <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-xl font-bold mb-4">Corredores Inscritos ({participants.length})</h3>
                <div className="flex -space-x-2 overflow-hidden">
                    {participants.map(p => (
                        <img 
                            key={p.id}
                            className="inline-block h-10 w-10 rounded-full ring-2 ring-white"
                            src={p.user.photoUrl || '/default-avatar.png'}
                            alt={p.user.name}
                        />
                    ))}
                </div>
            </div>
        </div>
    );
};
    </code></pre>
    </div>

    <!-- SECCIÓN 10: MANUAL DE DESPLIEGUE -->
    <div class="a4-page">
        <h1>10. Manual de Despliegue (DevOps)</h1>
        <p>
            El despliegue se ha realizado utilizando una estrategia de CI/CD manual pero optimizada para la capa
            gratuita de proveedores Cloud.
        </p>

        <h2>10.1. Logs de Despliegue Backend (Simulación)</h2>
        <div class="log-terminal">
            $ git push origin main
            Enumerating objects: 145, done.
            Counting objects: 100% (145/145), done.
            Delta compression using up to 8 threads
            Compressing objects: 100% (89/89), done.
            Writing objects: 100% (102/102), 25.40 KiB | 5.08 MiB/s, done.
            Total 102 (delta 45), reused 0 (delta 0), pack-reused 0
            remote: Resolving deltas: 100% (45/45), completed with 12 local objects.
            To https://github.com/eduuber777/runtogether.git
            8a2b3c..9d8e7f main -> main

            [RENDER] Build started for service runtogether-backend
            [RENDER] Cloning repository...
            [RENDER] Running 'npm install'...
            added 450 packages in 12s
            [RENDER] Running 'npx prisma generate'...
            Prisma schema loaded from prisma/schema.prisma
            ✔ Generated Prisma Client (v5.7.0) to ./node_modules/@prisma/client in 89ms
            [RENDER] Starting service with 'npm start'...
            > runtogether-backend@1.0.0 start
            > node src/server.js
            Server running on port 10000
            Connected to MongoDB Atlas
        </div>

        <h2>10.2. Variables de Entorno de Producción</h2>
        <table>
            <tr>
                <th>Variable</th>
                <th>Valor (Ofuscado)</th>
                <th>Descripción</th>
            </tr>
            <tr>
                <td>DATABASE_URL</td>
                <td>mongodb+srv://user:****@cluster0.mongodb.net/prod</td>
                <td>String de conexión a la base de datos de producción.</td>
            </tr>
            <tr>
                <td>JWT_SECRET</td>
                <td>************************</td>
                <td>Clave privada de 256 bits para firmar tokens.</td>
            </tr>
            <tr>
                <td>NODE_ENV</td>
                <td>production</td>
                <td>Activa optimizaciones de Express y desactiva logs de debug.</td>
            </tr>
        </table>
    </div>

    <!-- ANEXO I: CÓDIGO FUENTE COMPLETO -->
    <div class="a4-page">
        <h1>11. Anexo I: Código Fuente Completo</h1>
        <p>
            Para garantizar la reproducibilidad y auditoría del proyecto, se adjunta el código fuente de los componentes
            críticos.
        </p>

        <h3>backend/prisma/schema.prisma</h3>
        <pre><code class="language-prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  password      String
  name          String
  role          Role      @default(RUNNER)
  level         Level?
  photoUrl      String?
  createdAt     DateTime  @default(now())
  
  inscriptions  Inscription[]
  posts         Post[]
  comments      Comment[]
  notifications Notification[]
}

model Event {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  date            DateTime
  location        String
  distance        Float
  price           Float    @default(0)
  imageUrl        String?
  difficulty      Difficulty @default(BEGINNER)
  maxParticipants Int?
  elevation       Float?
  terrainType     Terrain?
  
  inscriptions    Inscription[]
  comments        Comment[]
}

// ... (Resto del esquema omitido por brevedad en esta vista previa, pero incluido en el documento real)
    </code></pre>
    </div>

</body>

</html>