<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria Técnica Extensa - RunTogether - Eduard Berlanga</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Source+Code+Pro:wght@400;600&display=swap');

        :root {
            --primary: #0056b3;
            --secondary: #00a8e8;
            --dark: #333;
            --light: #f4f4f4;
            --code-bg: #1e1e1e;
            --border: #ddd;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.8;
            color: #333;
            margin: 0;
            background: #f9f9f9;
        }

        /* Layout de impresión A4 */
        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 25mm;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
        }

        @media print {
            body {
                background: white;
            }

            .page {
                margin: 0;
                box-shadow: none;
                width: 100%;
            }
        }

        /* Tipografía */
        h1 {
            color: var(--primary);
            font-size: 24pt;
            border-bottom: 3px solid var(--secondary);
            padding-bottom: 10px;
            margin-top: 0;
        }

        h2 {
            color: var(--dark);
            font-size: 18pt;
            margin-top: 30px;
            border-left: 5px solid var(--secondary);
            padding-left: 15px;
            background: #f0f8ff;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        h3 {
            color: var(--primary);
            font-size: 14pt;
            margin-top: 25px;
        }

        h4 {
            font-size: 12pt;
            font-weight: bold;
            color: #555;
            margin-top: 20px;
        }

        p {
            text-align: justify;
            margin-bottom: 15px;
        }

        /* Componentes */
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }

        .toc>ul>li {
            font-weight: bold;
            margin-top: 10px;
            border-bottom: 1px dotted #ccc;
        }

        .toc ul ul {
            padding-left: 20px;
            font-weight: normal;
        }

        .code-block {
            background: var(--code-bg);
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Source Code Pro', monospace;
            font-size: 9pt;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 5px solid var(--secondary);
        }

        .keyword {
            color: #569cd6;
        }

        .string {
            color: #ce9178;
        }

        .comment {
            color: #6a9955;
        }

        .function {
            color: #dcdcaa;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: var(--primary);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .alert {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        /* Portada */
        .cover-title {
            text-align: center;
            margin-top: 150px;
        }

        .cover-logo {
            font-size: 80px;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 50px;
        }

        .cover-details {
            margin-top: 100px;
            border-top: 2px solid var(--primary);
            padding-top: 30px;
        }
    </style>
</head>

<body>

    <!-- PORTADA -->
    <div class="page">
        <div class="cover-logo">UOC</div>
        <div class="cover-title">
            <h1 style="border: none; font-size: 36pt; margin-bottom: 20px;">MEMORIA TÉCNICA FINAL</h1>
            <h2 style="border: none; background: none; font-size: 24pt; color: #666;">Proyecto: RunTogether</h2>
            <p style="text-align: center; font-size: 16pt;">Plataforma Integral de Gestión de Eventos Deportivos</p>
        </div>

        <div class="cover-details">
            <table style="border: none;">
                <tr style="background: none;">
                    <td style="border: none; font-weight: bold; width: 30%;">Autor:</td>
                    <td style="border: none;">Eduard Berlanga González</td>
                </tr>
                <tr style="background: none;">
                    <td style="border: none; font-weight: bold;">Asignatura:</td>
                    <td style="border: none;">Programación Web Avanzada</td>
                </tr>
                <tr style="background: none;">
                    <td style="border: none; font-weight: bold;">Consultor:</td>
                    <td style="border: none;">Mikel Zorrilla Berasategui</td>
                </tr>
                <tr style="background: none;">
                    <td style="border: none; font-weight: bold;">Fecha:</td>
                    <td style="border: none;">Diciembre 2025</td>
                </tr>
                <tr style="background: none;">
                    <td style="border: none; font-weight: bold;">Entregas Cubiertas:</td>
                    <td style="border: none;">PEC 2, PEC 3, PEC 4</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ÍNDICE -->
    <div class="page">
        <h1>Índice de Contenidos</h1>
        <div class="toc">
            <ul>
                <li>1. Resumen Ejecutivo</li>
                <li>2. Análisis del Proyecto y Evolución
                    <ul>
                        <li>2.1. Fase 1: Backend y API REST (PEC 2)</li>
                        <li>2.2. Fase 2: Frontend y SPA (PEC 3)</li>
                        <li>2.3. Fase 3: Integración y Despliegue (PEC 4)</li>
                    </ul>
                </li>
                <li>3. Arquitectura Técnica Detallada
                    <ul>
                        <li>3.1. Diagrama de Arquitectura</li>
                        <li>3.2. Stack Tecnológico Justificado</li>
                        <li>3.3. Estructura de Directorios</li>
                    </ul>
                </li>
                <li>4. Base de Datos y Modelo de Datos
                    <ul>
                        <li>4.1. Diseño del Esquema (Prisma)</li>
                        <li>4.2. Relaciones entre Entidades</li>
                    </ul>
                </li>
                <li>5. Desarrollo del Backend (Paso a Paso)
                    <ul>
                        <li>5.1. Configuración del Servidor</li>
                        <li>5.2. Middleware de Seguridad y Autenticación</li>
                        <li>5.3. Controladores y Lógica de Negocio</li>
                    </ul>
                </li>
                <li>6. Desarrollo del Frontend (Paso a Paso)
                    <ul>
                        <li>6.1. Configuración de Vite y React</li>
                        <li>6.2. Sistema de Rutas y Protección</li>
                        <li>6.3. Gestión del Estado (Context API)</li>
                        <li>6.4. Componentes y Diseño (Tailwind)</li>
                    </ul>
                </li>
                <li>7. Funcionalidades Clave Implementadas
                    <ul>
                        <li>7.1. Sistema de Autenticación Completo</li>
                        <li>7.2. Gestión de Eventos e Inscripciones</li>
                        <li>7.3. Muro Social y Comunidad</li>
                        <li>7.4. Sistema de Notificaciones (PEC 4)</li>
                        <li>7.5. Panel de Administración (PEC 4)</li>
                    </ul>
                </li>
                <li>8. Solución de Problemas y Retos
                    <ul>
                        <li>8.1. Problemas de CORS</li>
                        <li>8.2. Gestión de Estado Asíncrono</li>
                        <li>8.3. Despliegue y Variables de Entorno</li>
                    </ul>
                </li>
                <li>9. Manual de Despliegue y Operación
                    <ul>
                        <li>9.1. Entorno Local</li>
                        <li>9.2. Entorno de Producción (Cloud)</li>
                    </ul>
                </li>
                <li>10. Conclusiones y Trabajo Futuro</li>
            </ul>
        </div>
    </div>

    <!-- 1. RESUMEN EJECUTIVO -->
    <div class="page">
        <h1>1. Resumen Ejecutivo</h1>
        <p>
            RunTogether es una plataforma web Full Stack diseñada para facilitar la organización y participación en
            eventos de running. El proyecto nace de la necesidad de conectar a organizadores de carreras con una
            comunidad activa de corredores, proporcionando herramientas para la gestión de inscripciones, la interacción
            social y el seguimiento de actividades.
        </p>
        <p>
            Este documento detalla el proceso completo de ingeniería de software llevado a cabo durante el semestre,
            abarcando desde el diseño inicial de la base de datos y la API en la PEC 2, pasando por la construcción de
            una interfaz de usuario reactiva en la PEC 3, hasta la implementación de funcionalidades avanzadas de
            administración, notificaciones y el despliegue final en la nube en la PEC 4.
        </p>
        <div class="success">
            <strong>Logro Principal:</strong> Se ha entregado una aplicación 100% funcional, desplegada en producción,
            que cumple con todos los requisitos funcionales y no funcionales establecidos, incluyendo una arquitectura
            escalable y segura.
        </div>
    </div>

    <!-- 2. ANÁLISIS Y EVOLUCIÓN -->
    <div class="page">
        <h1>2. Análisis del Proyecto y Evolución</h1>

        <h2>2.1. Fase 1: Backend y API REST (PEC 2)</h2>
        <p>
            El objetivo inicial fue construir una base sólida. Se optó por una arquitectura RESTful para desacoplar el
            servidor del cliente.
        </p>
        <ul>
            <li><strong>Hito 1:</strong> Configuración de Node.js y Express.</li>
            <li><strong>Hito 2:</strong> Definición de modelos con Prisma ORM. Se eligió Prisma por su seguridad de
                tipos y facilidad de migración.</li>
            <li><strong>Hito 3:</strong> Implementación de JWT (JSON Web Tokens). Decisión crítica para permitir
                sesiones sin estado (stateless), ideal para escalabilidad.</li>
        </ul>

        <h2>2.2. Fase 2: Frontend y SPA (PEC 3)</h2>
        <p>
            Con la API lista, el foco se trasladó a la experiencia de usuario. Se eligió React por su ecosistema y
            componentización.
        </p>
        <ul>
            <li><strong>Hito 1:</strong> Configuración de Vite. Se prefirió sobre Create React App por su velocidad de
                compilación.</li>
            <li><strong>Hito 2:</strong> Diseño con Tailwind CSS. Permitió un desarrollo rápido de UI sin salir del HTML
                (JSX), manteniendo consistencia visual.</li>
            <li><strong>Hito 3:</strong> Integración con API. Uso de Axios e interceptores para manejar tokens
                automáticamente.</li>
        </ul>

        <h2>2.3. Fase 3: Integración y Despliegue (PEC 4)</h2>
        <p>
            La fase final se centró en "profesionalizar" la aplicación.
        </p>
        <ul>
            <li><strong>Notificaciones:</strong> Se añadió un sistema de polling para alertar al usuario de
                interacciones.</li>
            <li><strong>Administración:</strong> Se creó un dashboard protegido para gestión de contenidos.</li>
            <li><strong>Despliegue:</strong> Se configuraron pipelines de despliegue continuo en Render y Netlify.</li>
        </ul>
    </div>

    <!-- 3. ARQUITECTURA TÉCNICA -->
    <div class="page">
        <h1>3. Arquitectura Técnica Detallada</h1>

        <h2>3.1. Stack Tecnológico Justificado</h2>
        <p>La elección del stack MERN (MongoDB, Express, React, Node) modificado con Prisma y SQL (en desarrollo)
            responde a criterios de modernidad y demanda de mercado.</p>

        <table>
            <thead>
                <tr>
                    <th>Tecnología</th>
                    <th>Rol</th>
                    <th>Justificación</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Node.js</strong></td>
                    <td>Runtime</td>
                    <td>Permite usar JavaScript en todo el stack, unificando el lenguaje y compartiendo tipos/lógica.
                    </td>
                </tr>
                <tr>
                    <td><strong>Express</strong></td>
                    <td>Framework Backend</td>
                    <td>Minimalista, flexible y con el mayor ecosistema de middleware del mercado.</td>
                </tr>
                <tr>
                    <td><strong>Prisma</strong></td>
                    <td>ORM</td>
                    <td>Abstracción superior a Mongoose/Sequelize. Autocompletado y migraciones seguras.</td>
                </tr>
                <tr>
                    <td><strong>React</strong></td>
                    <td>Librería Frontend</td>
                    <td>Componentización, Virtual DOM para rendimiento y gestión de estado eficiente.</td>
                </tr>
                <tr>
                    <td><strong>Tailwind CSS</strong></td>
                    <td>Estilos</td>
                    <td>Utility-first. Reduce el tamaño del CSS final y acelera el desarrollo.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 4. BASE DE DATOS -->
    <div class="page">
        <h1>4. Base de Datos y Modelo de Datos</h1>
        <p>El esquema de datos es el corazón de la aplicación. Se ha diseñado para mantener la integridad referencial y
            soportar las consultas complejas de la red social.</p>

        <h2>4.1. Esquema Prisma (schema.prisma)</h2>
        <p>A continuación se detalla el código fuente del esquema final:</p>

        <div class="code-block">
            <span class="keyword">model</span> User {
            id <span class="function">String</span> @id @default(auto()) @map("_id") @db.ObjectId
            email <span class="function">String</span> @unique
            password <span class="function">String</span>
            name <span class="function">String</span>
            role Role @default(RUNNER)
            level Level?
            photoUrl <span class="function">String?</span>

            <span class="comment">// Relaciones</span>
            inscriptions Inscription[]
            posts Post[]
            comments Comment[]
            notifications Notification[]
            }

            <span class="keyword">model</span> Event {
            id <span class="function">String</span> @id @default(auto()) @map("_id") @db.ObjectId
            title <span class="function">String</span>
            description <span class="function">String</span>
            date <span class="function">DateTime</span>
            location <span class="function">String</span>
            distance <span class="function">Float</span>
            price <span class="function">Float</span> @default(0)
            maxParticipants <span class="function">Int?</span>

            <span class="comment">// Relaciones</span>
            inscriptions Inscription[]
            comments Comment[]
            }
        </div>

        <h2>4.2. Explicación de Relaciones</h2>
        <ul>
            <li><strong>User 1:N Inscription:</strong> Un usuario puede inscribirse a muchos eventos.</li>
            <li><strong>Event 1:N Inscription:</strong> Un evento tiene muchas inscripciones.</li>
            <li><strong>User 1:N Post:</strong> Relación para el muro social.</li>
            <li><strong>User 1:N Notification:</strong> Sistema de alertas personalizado.</li>
        </ul>
    </div>

    <!-- 5. DESARROLLO BACKEND -->
    <div class="page">
        <h1>5. Desarrollo del Backend (Detallado)</h1>

        <h2>5.1. Middleware de Autenticación (auth.js)</h2>
        <p>
            Uno de los componentes más críticos es el middleware de seguridad. Este código intercepta cada petición a
            rutas protegidas para verificar la identidad del usuario.
        </p>
        <div class="code-block">
            <span class="keyword">const</span> authenticateToken = (req, res, next) => {
            <span class="keyword">const</span> authHeader = req.headers[<span class="string">'authorization'</span>];
            <span class="keyword">const</span> token = authHeader && authHeader.split(<span class="string">'
                '</span>)[1];

            <span class="keyword">if</span> (!token) <span class="keyword">return</span> res.sendStatus(401); <span
                class="comment">// No autorizado</span>

            jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
            <span class="keyword">if</span> (err) <span class="keyword">return</span> res.sendStatus(403); <span
                class="comment">// Prohibido</span>
            req.user = user;
            next();
            });
            };
        </div>
        <p>
            <strong>Explicación:</strong> Se extrae el token del header `Authorization: Bearer <token>`. Si existe, se
                verifica con la clave secreta. Si es válido, se inyecta el objeto `user` en la `req`, permitiendo que
                los controladores posteriores sepan quién está haciendo la petición.
        </p>

        <h2>5.2. Controlador de Inscripciones</h2>
        <p>
            Este controlador maneja la lógica de negocio compleja: verificar duplicados, comprobar aforo y generar
            notificaciones.
        </p>
        <div class="alert">
            <strong>Solución a Problema:</strong> Inicialmente, un usuario podía inscribirse dos veces. Se solucionó
            añadiendo una comprobación `findUnique` compuesta por `userId_eventId` antes de crear el registro.
        </div>
    </div>

    <!-- 6. DESARROLLO FRONTEND -->
    <div class="page">
        <h1>6. Desarrollo del Frontend (Detallado)</h1>

        <h2>6.1. Gestión de Estado Global (AuthContext)</h2>
        <p>
            Para evitar el "prop drilling" (pasar props por muchos niveles), se implementó un Contexto de React para la
            sesión del usuario.
        </p>
        <p>
            El `AuthContext` provee:
        </p>
        <ul>
            <li><code>user</code>: Objeto con los datos del usuario actual.</li>
            <li><code>login(token, userData)</code>: Función para iniciar sesión y guardar en localStorage.</li>
            <li><code>logout()</code>: Función para limpiar sesión y redirigir.</li>
            <li><code>loading</code>: Estado para mostrar spinners mientras se verifica la sesión al recargar.</li>
        </ul>

        <h2>6.2. Interceptores de Axios</h2>
        <p>
            Para no repetir el código de añadir el token en cada llamada, se configuró una instancia de Axios
            centralizada.
        </p>
        <div class="code-block">
            api.interceptors.request.use((config) => {
            <span class="keyword">const</span> token = localStorage.getItem(<span class="string">'token'</span>);
            <span class="keyword">if</span> (token) {
            config.headers.Authorization = <span class="string">`Bearer ${token}`</span>;
            }
            <span class="keyword">return</span> config;
            });
        </div>
    </div>

    <!-- 7. FUNCIONALIDADES CLAVE -->
    <div class="page">
        <h1>7. Funcionalidades Clave Implementadas</h1>

        <h2>7.4. Sistema de Notificaciones (PEC 4)</h2>
        <p>
            Esta fue una de las adiciones más complejas de la fase final.
        </p>
        <h3>Implementación Backend</h3>
        <p>
            No se creó un endpoint de "crear notificación" público. En su lugar, las notificaciones se crean como
            <strong>efectos secundarios</strong> de otras acciones.
        </p>
        <ul>
            <li>Cuando se llama a <code>createInscription</code>, el controlador inserta automáticamente una
                notificación de tipo `EVENT`.</li>
            <li>Cuando se llama a <code>likePost</code>, se inserta una notificación de tipo `SOCIAL` al dueño del post.
            </li>
        </ul>

        <h3>Implementación Frontend</h3>
        <p>
            En el componente `Navbar`, se utiliza un `setInterval` para consultar cada 60 segundos el endpoint
            `/notifications/unread-count`. Esto mantiene el badge rojo actualizado casi en tiempo real sin necesidad de
            WebSockets (reduciendo complejidad).
        </p>

        <h2>7.5. Panel de Administración</h2>
        <p>
            Se creó una ruta protegida `/admin` que verifica `user.role === 'ADMIN'`.
        </p>
        <p>
            <strong>Funcionalidades del Panel:</strong>
        </p>
        <ul>
            <li><strong>CRUD de Eventos:</strong> Se reutilizó el componente `EventForm` para crear y editar, pasando
                props condicionales.</li>
            <li><strong>Gestión de Usuarios:</strong> Tabla con paginación (implícita) para ver todos los registros y
                botón de eliminar con confirmación `window.confirm`.</li>
        </ul>
    </div>

    <!-- 8. SOLUCIÓN DE PROBLEMAS -->
    <div class="page">
        <h1>8. Solución de Problemas y Retos</h1>

        <h2>8.1. Problema de CORS en Producción</h2>
        <p>
            <strong>Síntoma:</strong> Al desplegar, el frontend (Netlify) no podía comunicarse con el backend (Render).
        </p>
        <p>
            <strong>Causa:</strong> El navegador bloqueaba las peticiones por seguridad al ser dominios distintos.
        </p>
        <p>
            <strong>Solución:</strong> Se configuró el paquete `cors` en Express permitiendo explícitamente el origen
            del frontend o usando `*` (solo para desarrollo/pruebas).
        </p>
        <div class="code-block">
            app.use(cors({
            origin: process.env.FRONTEND_URL || <span class="string">'*'</span>
            }));
        </div>

        <h2>8.2. Refresco de Datos en Componentes</h2>
        <p>
            <strong>Reto:</strong> Al añadir un comentario, la lista no se actualizaba inmediatamente.
        </p>
        <p>
            <strong>Solución:</strong> Se implementó actualización optimista en el estado local de React
            (`setComments([...comments, newComment])`) antes de volver a hacer fetch, mejorando la percepción de
            velocidad.
        </p>
    </div>

    <!-- 9. MANUAL DE DESPLIEGUE -->
    <div class="page">
        <h1>9. Manual de Despliegue y Operación</h1>

        <h2>9.1. Variables de Entorno Requeridas</h2>
        <p>Para que el sistema funcione, es imperativo configurar las siguientes variables:</p>

        <h3>Backend (.env)</h3>
        <ul>
            <li><code>DATABASE_URL</code>: String de conexión a MongoDB Atlas.</li>
            <li><code>JWT_SECRET</code>: Semilla para firmar tokens.</li>
            <li><code>PORT</code>: Puerto de escucha (por defecto 3000).</li>
        </ul>

        <h3>Frontend (.env)</h3>
        <ul>
            <li><code>VITE_API_URL</code>: URL base del backend desplegado (ej: https://runtogether.onrender.com/api).
            </li>
        </ul>

        <h2>9.2. Pasos de Verificación Post-Despliegue</h2>
        <ol>
            <li>Acceder a la URL del frontend.</li>
            <li>Intentar registrar un usuario nuevo. Si falla, revisar conexión a DB en logs de Render.</li>
            <li>Loguearse con el usuario Admin (creado por seed).</li>
            <li>Crear un evento de prueba y verificar que aparece en la Home.</li>
        </ol>
    </div>

    <!-- 10. CONCLUSIONES -->
    <div class="page">
        <h1>10. Conclusiones</h1>
        <p>
            El proyecto RunTogether ha sido un ejercicio exhaustivo de desarrollo Full Stack. Se ha logrado no solo
            cumplir con los requisitos académicos, sino crear un producto con calidad cercana a la producción.
        </p>
        <p>
            La arquitectura modular permitirá en el futuro añadir funcionalidades como pagos con Stripe o chat en tiempo
            real con Socket.io sin necesidad de refactorizar el núcleo de la aplicación.
        </p>
        <p>
            Este documento certifica el trabajo realizado y sirve como guía de referencia para el mantenimiento y
            escalado futuro de la plataforma.
        </p>
    </div>

</body>

</html>